---
title: "Identification of most severe weather events with respect to population health and economic cost based on observations from the NOAA database"
author: "Adam"
date: '2020-04-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Review criteria

1. Has either a (1) valid RPubs URL pointing to a data analysis document for this assignment been submitted; or (2) a complete PDF file presenting the data analysis been uploaded?

2. Is the document written in English?

3. Does the analysis include description and justification for any data transformations?

4. Does the document have a title that briefly summarizes the data analysis?

5. Does the document have a synopsis that describes and summarizes the data analysis in less than 10 sentences?

6. Is there a section titled "Data Processing" that describes how the data were loaded into R and processed for analysis?

7. Is there a section titled "Results" where the main results are presented?

8. Is there at least one figure in the document that contains a plot?

9. Are there at most 3 figures in this document?

10. Does the analysis start from the raw data file (i.e. the original .csv.bz2 file)?

11. Does the analysis address the question of which types of events are most harmful to population health?

12. Does the analysis address the question of which types of events have the greatest economic consequences?

13. Do all the results of the analysis (i.e. figures, tables, numerical summaries) appear to be reproducible?

14. Do the figure(s) have descriptive captions (i.e. there is a description near the figure of what is happening in the figure)?

15. As far as you can determine, does it appear that the work submitted for this project is the work of the student who submitted it?





## Synopsis

Analysis of weather event obserations from the NOAA Storm Database, aiming to answer the two following questions:

Q1: Which weather event is most harmful to population health?

Q2: Which weather event have the greatest economic consequences?

To summarize, it was found that XXX was the most harmful event for population health, with a mean death rate per event of XXX. (Should one count total deaths over time instead?) How to handle fatalities vs injuries?

It was found that YYY was the event with the greatest economic consequences, with a mean cost per event of YYY. (Should one count the total cost over time instead?) 

Link to download the dataset 

[Storm Data (47MB)](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2)

In the following link, the National Weather Service Storm Data Documentation can be found, describing the dataset and it's variables.

[National Weather Service Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)

In the next link, a FAQ from the National Climatic Data Center Storm Events can be found for the dataset.

[National Climatic Data Center Storm Events FAQ](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf)

---

## Data processing

Mention what steps is done in this section and present the code below for doing so.

Start by loading the required packages, then if the data is not present on the local machine, download and load it. 

```{r, message=FALSE, warning=FALSE}
## Load required packages
library(data.table)
library(dplyr)
library(ggplot2)
library(lubridate)

## Get data
if(!file.exists("repdata_data_StormData.csv.bz2")) {
  dataurl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
  download.file(dataurl, "repdata_data_StormData.csv.bz2")
}

## Load data
dat <- tbl_df(fread("repdata_data_StormData.csv.bz2"))

```

After the data has been loaded, perform pre-processing by creating a new column of datetime objects from the BGN_DATE column. As a first step, let's explore the different types of event that are tracked over time. On the NOAA website it is mentioned ([link](https://www.ncdc.noaa.gov/stormevents/details.jsp)) that all types of events are tracked from 1996 and forward. Let's see for ourselves.

```{r}
## Pre-process data

# Transform date column to date object
dat <- mutate(dat, DATE =  mdy_hms(BGN_DATE))

# Let's now check how many different events that are being tracked after 1996
amount96 <- length(unique(filter(dat, DATE >= "1996-01-01")$EVTYPE))
print(paste0("Number of unique weather events from 1993 and forward: ", amount96))


```

From these results we can see that as much as `r amount96` unique types are being recorded from 1996 and forward. This seems to be a bit high. By inspecting the data, one can see that from 1993 there are a lot of different variants of recording the same type of event. In the documentation it is mentioned that the true number of unique types is infact 48. In order to extract the data of interest, the dataset is first filtered on dates from 1996 and forward. Filtering is then performed so that only observations with correct weather event label are used.


```{r}

dat <- filter(dat, DATE >= "1996-01-01")

# Offical weather events from NOAA database documentaion
evtypes <- c("Astronomical Low Tide", "Avalanche", "Blizzard", "Coastal Flood",
            "Cold/Wind Chill", "Debris Flow", "Dense Fog", "Dense Smoke", 
            "Drought", "Dust Devil", "Dust Storm", "Excessive Heat",
            "Extreme Cold/Wind Chill", "Flash Flood", "Flood", "Frost/Freeze",
            "Funnel Cloud", "Freezing Fog", "Hail", "Heat",
            "Heavy Rain", "Heavy Snow", "High Surf", "High Wind",
            "Typhoon",  "Ice Storm", "Lake-Effect Snow", "Lakeshore Flood",
            "Lightning", "Marine Hail", "Marine High Wind", "Marine Strong Wind",
            "Marine Thunderstorm Wind", "Rip Current", "Seiche", "Sleet",
            "Storm Surge/Tide", "Strong Wind", "Thunderstorm Wind", "Tornado", 
            "Tropical Depression", "Tropical Storm", "Tsunami", "Volcanic Ash", 
            "Waterspout", "Wildfire", "Winter Storm", "Winter Weather")

dat <- filter(dat, EVTYPE %in% toupper(evtypes))

```

Filtering is then performed to create two new subsets of the data to be used for the two questions respectively. The first subset is called *harmdat*, containing information about the harmfulness of events, and is created by filtering out all events which have either non-zero fatalities or non-zero injuries.

```{r}


# Filter out data with events which have non-zero recorded values for fatalities or injuries
harmdat <- filter(dat, (FATALITIES != 0) | (INJURIES != 0))


```

The second subset of the data is called *econdat*, and contains all events with non-zero recorded values for property or crop damage. To enable us to take this subset, we must first create a new column merging the information in the PROPDMG and CROPDMG variables with the PROPDMGEXP and CROPDMGEXP variables, respectively.

```{r}

# Create vector with multiper values for each present symbol in EXP variables in the filtered dataset
multipliers <- c("0"=10, "K"=1e3, "M"=1e6, "B"=1e9)

# Create column in which information from propdmg and propdmgexp is combined
econdat <- mutate(dat, ACTPROPDMG = if_else(PROPDMGEXP != "", PROPDMG * multipliers[PROPDMGEXP], 0))

# Create column in which information from cropdmg and cropdmgexp is combined
econdat <- mutate(econdat, ACTCROPDMG = if_else(CROPDMGEXP != "", CROPDMG * multipliers[CROPDMGEXP], 0))

econdat <- filter(econdat, (ACTPROPDMG != 0 | ACTCROPDMG != 0))

```

The data is now ready for analysis! 

---

## Results

Present the two subsections targeting one question each, starting with Q1.

### Analysis for Q1

Mention method and present code to perform it. 

In order to answer the first question regarding which weather event that is most harmful for the population, the data is grouped by weather event and then both total fatalities and total injuries over time are calculated. One could also argue that one should look at the mean fatalities and injuries per event as that would tell how deadly or harmful one individual event would be on average. However now we take the perspective of which event has caused the most harm to the population over time, i.e. very deadly but rare events are not considered as more harmful than a common low to medium deadly event which is causing a lot of harm over time.

```{r}

## Analytic code
# Calculate total fatalities and total injuries per weather event
totharmdat <- harmdat %>% group_by(EVTYPE) %>% summarize(total_fatalities = sum(FATALITIES), total_injuries = sum(INJURIES))

# Print the top 10 weather events ranked by total property damage 
totharmdat %>% arrange(desc(total_fatalities), desc(total_injuries)) %>% top_n(n = 10, wt = total_fatalities)

```

Comment on result from analysis.

One can see that tornadoes is significantlly more deadly and is causing more injuries than any other weather event. In order to visualize this, figure [ref] is showing total fatalities versus total injuries per weather event.

Present figure and code for plotting.

```{r}

## Plot

```

Comment on figure.

One can observe more clearly the magnitude of the difference between harmfulness in events, where tornadoes far exceeds the other weather types.

### Analysis for Q2

Mention method and present code to perform it. 

```{r}

## Analytic code
# Calculate total property damage and total crop damage per weather event
totecondat <- econdat %>% group_by(EVTYPE) %>% summarize(total_propdmg = sum(ACTPROPDMG), total_cropdmg = sum(ACTCROPDMG))

# Print the top 10 weather events ranked by total fatalities 
totecondat %>% arrange(desc(total_propdmg), desc(total_cropdmg)) %>% top_n(n = 10, wt = total_propdmg)

```

Comment on result from analysis.

Present figure and code for plotting.

```{r}

## Plot

```

Comment on figure.

---

## Discussion and conclusion

Discussion of analysis and results.

Summarize and conclude.
